!function(r,t){"use strict";function e(r){for(var t=0;t<u.length;t++)if(u[t](r))return i.isRegExp(r)?{$regex:r}:{$eq:r};if(i.isObject(r)){var e=i.keys(r),n=0===i.intersection(m.queryOperators,e).length;if(n)return{$eq:r};if(i.contains(e,"$regex")){var o=r.$regex,s=r.$options||"",a="";i.isString(o)&&(a+=o.ignoreCase||s.indexOf("i")>=0?"i":"",a+=o.multiline||s.indexOf("m")>=0?"m":"",a+=o.global||s.indexOf("g")>=0?"g":"",o=new RegExp(o,a)),r.$regex=o,delete r.$options}}return r}var n,i,o={};null!=r&&(n=r.Mingo),o.noConflict=function(){return r.Mingo=n,o};var s="undefined"!=typeof exports&&"undefined"!=typeof require;s?(exports="undefined"!=typeof module&&module.exports?module.exports=o:o,i=require("underscore")):(r.Mingo=o,i=r._);var u=[i.isString,i.isBoolean,i.isNumber,i.isDate,i.isNull,i.isRegExp],a={key:"_id"};if(o.setup=function(r){i.extend(a,r||{})},o.Query=function(r,t){return this instanceof o.Query?(this._criteria=r,this._projection=t,this._compiled=[],void this._compile()):new o.Query(r,t)},o.Query.prototype={_compile:function(){if(!i.isEmpty(this._criteria)){if(i.isArray(this._criteria)||i.isFunction(this._criteria)||!i.isObject(this._criteria))throw new Error("Invalid type for criteria");for(var r in this._criteria)if(this._criteria.hasOwnProperty(r)){var t=this._criteria[r];if(i.contains(m.compoundOperators,r)){if(i.contains(["$not"],r))throw new Error("Invalid operator");this._processOperator(r,r,t)}else{t=e(t);for(var n in t)t.hasOwnProperty(n)&&this._processOperator(r,n,t[n])}}}},_processOperator:function(r,t,e){var n;if(i.contains(m.simpleOperators,t))n={test:function(n){var i=o._resolve(n,r);return p[t](i,e)}};else{if(!i.contains(m.compoundOperators,t))throw new Error("Invalid query operator '"+t+"' detected");n=l[t](r,e)}this._compiled.push(n)},test:function(r){for(var t=0;t<this._compiled.length;t++)if(!this._compiled[t].test(r))return!1;return!0},find:function(r,t){return new o.Cursor(r,this,t)},remove:function(r){for(var t=[],e=0;e<r.length;e++)this.test(r[e])||t.push(r[e]);return t}},s){var c=require("stream").Transform,f=require("util");o.Query.prototype.stream=function(r){return new o.Stream(this,r)},o.Stream=function(r,t){return this instanceof o.Stream?(t=t||{},i.extend(t,{objectMode:!0}),c.call(this,t),void(this._query=r)):new o.Stream(r,t)},f.inherits(o.Stream,c),o.Stream.prototype._transform=function(r,t,e){if(i.isObject(r)&&this._query.test(r))if(i.isEmpty(this._query._projection))this.push(r);else{var n=new o.Cursor([r],this._query);n.hasNext()&&this.push(n.next())}e()}}o.Cursor=function(r,t,e){return this instanceof o.Cursor?(this._query=t,this._collection=r,this._projection=e||t._projection,this._operators={},this._result=!1,void(this._position=0)):new o.Cursor(r,t,e)},o.Cursor.prototype={_fetch:function(){var r=this;if(this._result!==!1)return this._result;if(i.isObject(this._projection)&&i.extend(this._operators,{$project:this._projection}),!i.isArray(this._collection))throw new Error("Input collection is not of a valid type.");this._result=i.filter(this._collection,this._query.test,this._query);var t=[];if(i.each(["$sort","$skip","$limit","$project"],function(e){i.has(r._operators,e)&&t.push(i.pick(r._operators,e))}),t.length>0){var e=new o.Aggregator(t);this._result=e.run(this._result,this._query)}return this._result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(r){return i.extend(this._operators,{$skip:r}),this},limit:function(r){return i.extend(this._operators,{$limit:r}),this},sort:function(r){return i.extend(this._operators,{$sort:r}),this},next:function(){return this.hasNext()?this._fetch()[this._position++]:null},hasNext:function(){return this.count()>this._position},max:function(r){return y.$max(this._fetch(),r)},min:function(r){return y.$min(this._fetch(),r)},map:function(r){return i.map(this._fetch(),r)},forEach:function(r){i.each(this._fetch(),r)}},o.Aggregator=function(r){return this instanceof o.Aggregator?void(this._operators=r):new o.Aggregator(r)},o.Aggregator.prototype={run:function(r,t){if(!i.isEmpty(this._operators))for(var e=0;e<this._operators.length;e++){var n=this._operators[e];for(var o in n)n.hasOwnProperty(o)&&(r=t?h[o].call(t,r,n[o]):h[o](r,n[o]))}return r}},o._get=function(r,t){return i.result(r,t)},o._resolve=function(r,e){if(!e)return t;for(var n,s=e.split("."),u=r,a=0;a<s.length;a++){if(n=null===s[a].match(/^\d+$/),n&&i.isArray(u)){var c=[];i.each(u,function(r){i.isObject(r)&&c.push(o._resolve(r,s[a]))}),u=c}else u=o._get(u,s[a]);if(u===t)break}return u},o.compile=function(r,t){return new o.Query(r,t)},o.find=function(r,t,e){return new o.Query(t).find(r,e)},o.remove=function(r,t){return new o.Query(t).remove(r)},o.aggregate=function(r,t){if(!i.isArray(t))throw new Error("Aggregation pipeline must be an array");return new o.Aggregator(t).run(r)},o.CollectionMixin={query:function(r,t){return o.find(this.toJSON(),r,t)},aggregate:function(r){var t=[this.toJSON(),r];return o.aggregate.apply(null,t)}};var h={$group:function(r,t){var e=t[a.key],n=[],o=i.groupBy(r,function(r){var t=w(r,e,e);return n.push(t),t});n=i.uniq(n),t=i.omit(t,a.key);var s=[];return i.each(n,function(r){var e={};e[a.key]=r;for(var n in t)t.hasOwnProperty(n)&&(e[n]=_(o[r],n,t[n]));s.push(e)}),s},$match:function(r,t){var e=new o.Query(t);return e.find(r).all()},$project:function(r,e){if(i.isEmpty(e))return r;var n=[],o=i.keys(e);if(i.contains(o,a.key)){var s=e[a.key];(0===s||s===!1)&&(o=i.without(o,a.key))}else o.push(a.key);for(var u=0;u<r.length;u++){var c=r[u],f={};i.each(o,function(r){var n,o=e[r];if(r===a.key&&i.isEmpty(o))n=c[r];else if(i.isString(o))n=w(c,o,r);else if(1===o||o===!0)n=i.result(c,r);else if(i.isObject(o)){var s=i.keys(o);if(s=s.length>1?!1:s[0],s!==!1&&i.contains(m.projectionOperators,s)){var u=g[s](c,o[s],r);i.isUndefined(u)||(n=u)}else n=w(c,o,r)}n!==t&&(f[r]=i.isObject(n)?i.clone(n):n)}),n.push(f)}return n},$limit:function(r,t){return i.first(r,t)},$skip:function(r,t){return i.rest(r,t)},$unwind:function(r,t){for(var e=[],n=t.substr(1),s=0;s<r.length;s++){var u=r[s],a=o._get(u,n);if(!i.isArray(a))throw new Error("Target field '"+n+"' is not of type Array.");i.each(a,function(r){var t=i.clone(u);t[n]=r,e.push(t)})}return e},$sort:function(r,t){if(!i.isEmpty(t)&&i.isObject(t)){var e=i.keys(t);e.reverse().forEach(function(e){var n=[],s=i.groupBy(r,function(r){var t=o._resolve(r,e);return n.push(t),t});n=i.sortBy(i.uniq(n),function(r){return r}),-1===t[e]&&n.reverse(),r=[],i.each(n,function(t){Array.prototype.push.apply(r,s[t])})})}return r}},l={$and:function(r,t){if(!i.isArray(t))throw new Error("Invalid expression for $and criteria");var e=[];return i.each(t,function(r){e.push(new o.Query(r))}),{test:function(r){for(var t=0;t<e.length;t++)if(!e[t].test(r))return!1;return!0}}},$or:function(r,t){if(!i.isArray(t))throw new Error("Invalid expression for $or criteria");var e=[];return i.each(t,function(r){e.push(new o.Query(r))}),{test:function(r){for(var t=0;t<e.length;t++)if(e[t].test(r))return!0;return!1}}},$nor:function(r,t){if(!i.isArray(t))throw new Error("Invalid expression for $nor criteria");var e=this.$or("$or",t);return{test:function(r){return!e.test(r)}}},$not:function(r,t){var n={};n[r]=e(t);var i=new o.Query(n);return{test:function(r){return!i.test(r)}}},$where:function(r,t){return i.isFunction(t)||(t=new Function("return "+t+";")),{test:function(r){return t.call(r)===!0}}}},p={$eq:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return i.isEqual(r,e)}),r!==t},$ne:function(r,t){return!this.$eq(r,t)},$in:function(r,t){return r=i.isArray(r)?r:[r],i.intersection(r,t).length>0},$nin:function(r,t){return i.isUndefined(r)||!this.$in(r,t)},$lt:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return e>r}),r!==t},$lte:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return e>=r}),r!==t},$gt:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return r>e}),r!==t},$gte:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return r>=e}),r!==t},$mod:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return i.isNumber(r)&&i.isArray(e)&&2===e.length&&r%e[0]===e[1]}),r!==t},$regex:function(r,e){return r=i.isArray(r)?r:[r],r=i.find(r,function(r){return i.isString(r)&&i.isRegExp(e)&&!!r.match(e)}),r!==t},$exists:function(r,t){return t===!1&&i.isUndefined(r)||t===!0&&!i.isUndefined(r)},$all:function(r,t){var e=this,n=!1;if(i.isArray(r)&&i.isArray(t))for(var o=0;o<t.length;o++){if(!i.isObject(t[o])||!i.contains(i.keys(t[o]),"$elemMatch"))return i.intersection(t,r).length===t.length;n=n||e.$elemMatch(r,t[o].$elemMatch)}return n},$size:function(r,t){return i.isArray(r)&&i.isNumber(t)&&r.length===t},$elemMatch:function(r,t){if(i.isArray(r)&&!i.isEmpty(r))for(var e=new o.Query(t),n=0;n<r.length;n++)if(e.test(r[n]))return!0;return!1},$type:function(r,t){switch(t){case 1:return i.isNumeric(r)&&-1!==(r+"").indexOf(".");case 2:case 5:return i.isString(r);case 3:return i.isObject(r);case 4:return i.isArray(r);case 8:return i.isBoolean(r);case 9:return i.isDate(r);case 10:return i.isNull(r);case 11:return i.isRegExp(r);case 16:return i.isNumeric(r)&&2147483647>=r&&-1===(r+"").indexOf(".");case 18:return i.isNumeric(r)&&r>2147483647&&0x8000000000000000>=r&&-1===(r+"").indexOf(".");default:return!1}}},g={$:function(){throw new Error("$ not implemented")},$elemMatch:function(r,e,n){var s=o._resolve(r,n),u=new o.Query(e);if(i.isUndefined(s)||!i.isArray(s))return t;for(var a=0;a<s.length;a++)if(u.test(s[a]))return s[a];return t},$slice:function(r,e,n){var s=o._resolve(r,n);return i.isUndefined(s)?t:(i.isArray(e)||(e=[e]),Array.prototype.slice.apply(s,e))}},y={$addToSet:function(r,t){var e=i.map(r,function(r){return w(r,t)});return i.uniq(e)},$sum:function(r,t){return i.isNumber(t)?r.length*t:i.reduce(r,function(r,e){return r+w(e,t)},0)},$max:function(r,t){var e=i.max(r,function(r){return w(r,t)});return w(e,t)},$min:function(r,t){var e=i.min(r,function(r){return w(r,t)});return w(e,t)},$avg:function(r,t){return this.$sum(r,t)/r.length},$push:function(r,t){return i.map(r,function(r){return w(r,t)})},$first:function(r,e){return r.length>0?w(r[0],e):t},$last:function(r,e){return r.length>0?w(r[r.length-1],e):t}},v={$add:function(r,t){var e=w(r,t);return i.reduce(e,function(r,t){return r+t},0)},$subtract:function(r,t){var e=w(r,t);return e[0]-e[1]},$divide:function(r,t){var e=w(r,t);return e[0]/e[1]},$multiply:function(r,t){var e=w(r,t);return i.reduce(e,function(r,t){return r*t},1)},$mod:function(r,t){var e=w(r,t);return e[0]%e[1]},$cmp:function(r,t){var e=w(r,t);return e[0]>e[1]?1:e[0]<e[1]?-1:0},$concat:function(r,e){var n=w(r,e);return i.contains(n,null)||i.contains(n,t)?null:n.join("")},$strcasecmp:function(r,t){var e=w(r,t);return e[0]=i.isEmpty(e[0])?"":e[0].toUpperCase(),e[1]=i.isEmpty(e[1])?"":e[1].toUpperCase(),e[0]>e[1]?1:e[0]<e[1]?-1:0},$substr:function(r,t){var e=w(r,t);return i.isString(e[0])?e[1]<0?"":e[2]<0?e[0].substr(e[1]):e[0].substr(e[1],e[2]):""},$toLower:function(r,t){var e=w(r,t);return i.isEmpty(e)?"":e.toLowerCase()},$toUpper:function(r,t){var e=w(r,t);return i.isEmpty(e)?"":e.toUpperCase()}},$={$setEquals:function(r,t){var e=w(r,t),n=i.uniq(e[0]),o=i.uniq(e[1]);return n.length!==o.length?!1:0==i.difference(n,o).length},$setIntersection:function(r,t){var e=w(r,t);return i.intersection(e[0],e[1])},$setDifference:function(r,t){var e=w(r,t);return i.difference(e[0],e[1])},$setUnion:function(r,t){var e=w(r,t);return i.union(e[0],e[1])},$setIsSubset:function(r,t){var e=w(r,t);return i.intersection(e[0],e[1]).length===e[0].length},$anyElementTrue:function(r,t){for(var e=w(r,t)[0],n=0;n<e.length;n++)if(e[n])return!0;return!1},$allElementsTrue:function(r,t){for(var e=w(r,t)[0],n=0;n<e.length;n++)if(!e[n])return!1;return!0}},d={$cond:function(r,t){var e,n,o;if(i.isArray(t)){if(3!=t.length)throw new Error("Invalid arguments for $cond operator");e=t[0],n=t[1],o=t[2]}else i.isObject(t)&&(e=t["if"],n=t.then,o=t["else"]);var s=w(r,e);return s?w(r,n):w(r,o)},$ifNull:function(r,e){if(!i.isArray(e)||2!=e.length)throw new Error("Invalid arguments for $ifNull operator");var n=w(r,e);return null===n[0]||n[0]===t?n[1]:n[0]}};i.each(["$eq","$ne","$gt","$gte","$lt","$lte"],function(r){v[r]=function(t,e){var n=w(t,e);return p[r](n[0],n[1])}}),i.extend(v,$,d);var m={simpleOperators:i.keys(p),compoundOperators:i.keys(l),setOperators:i.keys($),aggregateOperators:i.keys(v),groupOperators:i.keys(y),pipelineOperators:i.keys(h),projectionOperators:i.keys(g)};m.queryOperators=i.union(m.simpleOperators,m.compoundOperators);var _=function(r,e,n){if(i.contains(m.groupOperators,e))return y[e](r,n);if(i.isObject(n)){var o={};for(var s in n)if(n.hasOwnProperty(s)&&(o[s]=_(r,s,n[s]),i.contains(m.groupOperators,s))){if(o=o[s],i.keys(n).length>1)throw new Error("Invalid $group expression '"+JSON.stringify(n)+"'");break}return o}return t},w=function(r,t,e){if(i.contains(m.aggregateOperators,e))return v[e](r,t);if(i.isString(t)&&t.length>0&&"$"===t[0])return o._resolve(r,t.slice(1));var n;if(i.isArray(t)){n=[];for(var s=0;s<t.length;s++)n.push(w(r,t[s],null))}else if(i.isObject(t)){n={};for(var a in t)if(t.hasOwnProperty(a)&&(n[a]=w(r,t[a],a),i.contains(m.aggregateOperators,a))){if(n=n[a],i.keys(t).length>1)throw new Error("Invalid aggregation expression '"+JSON.stringify(t)+"'");break}}else for(var s=0;s<u.length;s++)if(u[s](t))return t;return n}}(this);