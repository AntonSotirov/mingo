!function(r,n){"use strict";function t(r){for(var n=0;n<l.length;n++)if(l[n](r))return a.isRegExp(r)?{$regex:r}:{$eq:r};if(a.isObject(r)){var t=a.keys(r),e=0===a.intersection(S.queryOperators,t).length;if(e)return{$eq:r};if(a.contains(t,"$regex")){var i=r.$regex,u=r.$options||"",o="";a.isString(i)&&(o+=i.ignoreCase||u.indexOf("i")>=0?"i":"",o+=i.multiline||u.indexOf("m")>=0?"m":"",o+=i.global||u.indexOf("g")>=0?"g":"",i=new RegExp(i,o)),r.$regex=i,delete r.$options}}return r}function e(r,n){return a.result(r,n)}function i(r,t){if(!t)return n;for(var u,o=t.split("."),s=r,c=0;c<o.length;c++){if(u=null===o[c].match(/^\d+$/),u&&a.isArray(s)){var f=[];a.each(s,function(r){a.isObject(r)&&f.push(i(r,o[c]))}),s=f}else s=e(s,o[c]);if(s===n)break}return s}function u(r,t,e){if(a.contains(S.groupOperators,t))return m[t](r,e);if(a.isObject(e)){var i={};for(var o in e)if(e.hasOwnProperty(o)&&(i[o]=u(r,o,e[o]),a.contains(S.groupOperators,o))){if(i=i[o],a.keys(e).length>1)throw new Error("Invalid $group expression '"+JSON.stringify(e)+"'");break}return i}return n}function o(r,n,t){if(a.contains(S.aggregateOperators,t))return N[t](r,n);if(a.isString(n)&&n.length>0&&"$"===n[0])return i(r,n.slice(1));var e;if(a.isArray(n))e=a.map(n,function(n){return o(r,n,null)});else if(a.isObject(n)){e={};for(var u in n)if(n.hasOwnProperty(u)&&(e[u]=o(r,n[u],u),a.contains(S.aggregateOperators,u))){if(e=e[u],a.keys(n).length>1)throw new Error("Invalid aggregation expression '"+JSON.stringify(n)+"'");break}}else for(var s=0;s<l.length;s++)if(l[s](n))return n;return e}var s,a,c={};null!=r&&(s=r.Mingo),c.noConflict=function(){return r.Mingo=s,c};var f="undefined"!=typeof exports&&"undefined"!=typeof require;f?(exports="undefined"!=typeof module&&module.exports?module.exports=c:c,a=require("underscore")):(r.Mingo=c,a=r._);var l=[a.isString,a.isBoolean,a.isNumber,a.isDate,a.isNull,a.isRegExp],h={key:"_id"};if(c.setup=function(r){a.extend(h,r||{})},c.Query=function(r,n){return this instanceof c.Query?(this._criteria=r,this._projection=n,this._compiled=[],void this._compile()):new c.Query(r,n)},c.Query.prototype={_compile:function(){if(!a.isEmpty(this._criteria)){if(a.isArray(this._criteria)||a.isFunction(this._criteria)||!a.isObject(this._criteria))throw new Error("Invalid type for criteria");for(var r in this._criteria)if(this._criteria.hasOwnProperty(r)){var n=this._criteria[r];if(a.contains(["$and","$or","$nor","$where"],r))this._processOperator(r,r,n);else{n=t(n);for(var e in n)n.hasOwnProperty(e)&&this._processOperator(r,e,n[e])}}}},_processOperator:function(r,n,t){var e;if(a.contains(S.simpleOperators,n))e={test:function(e){var u=i(e,r);return $[n](u,t)}};else{if(!a.contains(S.compoundOperators,n))throw new Error("Invalid query operator '"+n+"' detected");e=y[n](r,t)}this._compiled.push(e)},test:function(r){for(var n=0;n<this._compiled.length;n++)if(!this._compiled[n].test(r))return!1;return!0},find:function(r,n){return new c.Cursor(r,this,n)},remove:function(r){for(var n=[],t=0;t<r.length;t++)this.test(r[t])||n.push(r[t]);return n}},f){var p=require("stream").Transform,g=require("util");c.Query.prototype.stream=function(r){return new c.Stream(this,r)},c.Stream=function(r,n){return this instanceof c.Stream?(n=n||{},a.extend(n,{objectMode:!0}),p.call(this,n),void(this._query=r)):new c.Stream(r,n)},g.inherits(c.Stream,p),c.Stream.prototype._transform=function(r,n,t){if(a.isObject(r)&&this._query.test(r))if(a.isEmpty(this._query._projection))this.push(r);else{var e=new c.Cursor([r],this._query);e.hasNext()&&this.push(e.next())}t()}}c.Cursor=function(r,n,t){return this instanceof c.Cursor?(this._query=n,this._collection=r,this._projection=t||n._projection,this._operators={},this._result=!1,void(this._position=0)):new c.Cursor(r,n,t)},c.Cursor.prototype={_fetch:function(){var r=this;if(this._result!==!1)return this._result;if(a.isObject(this._projection)&&a.extend(this._operators,{$project:this._projection}),!a.isArray(this._collection))throw new Error("Input collection is not of valid type. Must be an Array.");this._result=a.filter(this._collection,this._query.test,this._query);var n=[];if(a.each(["$sort","$skip","$limit","$project"],function(t){a.has(r._operators,t)&&n.push(a.pick(r._operators,t))}),n.length>0){var t=new c.Aggregator(n);this._result=t.run(this._result,this._query)}return this._result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(r){return a.extend(this._operators,{$skip:r}),this},limit:function(r){return a.extend(this._operators,{$limit:r}),this},sort:function(r){return a.extend(this._operators,{$sort:r}),this},next:function(){return this.hasNext()?this._fetch()[this._position++]:null},hasNext:function(){return this.count()>this._position},max:function(r){return m.$max(this._fetch(),r)},min:function(r){return m.$min(this._fetch(),r)},map:function(r){return a.map(this._fetch(),r)},forEach:function(r){a.each(this._fetch(),r)}},c.Aggregator=function(r){return this instanceof c.Aggregator?void(this._operators=r):new c.Aggregator(r)},c.Aggregator.prototype={run:function(r,n){if(!a.isEmpty(this._operators))for(var t=0;t<this._operators.length;t++){var e=this._operators[t],i=a.keys(e);if(1!=i.length||!a.contains(S.pipelineOperators,i[0]))throw new Error("Invalid aggregation operator '"+i+"'");i=i[0],r=n instanceof c.Query?v[i].call(n,r,e[i]):v[i](r,e[i])}return r}},c.find=function(r,n,t){return new c.Query(n).find(r,t)},c.remove=function(r,n){return new c.Query(n).remove(r)},c.aggregate=function(r,n){if(!a.isArray(n))throw new Error("Aggregation pipeline must be an array");return new c.Aggregator(n).run(r)},c.CollectionMixin={query:function(r,n){return c.find(this.toJSON(),r,n)},aggregate:function(r){var n=[this.toJSON(),r];return c.aggregate.apply(null,n)}};var v={$group:function(r,n){var t=n[h.key],e=[],i=a.groupBy(r,function(r){var n=o(r,t,t);return e.push(n),n});e=a.uniq(e),n=a.omit(n,h.key);var s=[];return a.each(e,function(r){var t={};t[h.key]=r;for(var e in n)n.hasOwnProperty(e)&&(t[e]=u(i[r],e,n[e]));s.push(t)}),s},$match:function(r,n){return new c.Query(n).find(r).all()},$project:function(r,t){if(a.isEmpty(t))return r;var e=[],i=a.keys(t);if(a.contains(i,h.key)){var u=t[h.key];(0===u||u===!1)&&(i=a.without(i,h.key))}else i.push(h.key);for(var s=0;s<r.length;s++){var c=r[s],f={},l=!1,p=[];a.each(i,function(r){var e,i=t[r];if(r===h.key&&a.isEmpty(i))e=c[r];else if(a.isString(i))e=o(c,i,r);else if(1===i||i===!0)e=a.result(c,r);else if(a.isObject(i)){var u=a.keys(i);if(u=u.length>1?!1:u[0],u!==!1&&a.contains(S.projectionOperators,u)){var s=d[u](c,i[u],r);a.isUndefined(s)||(e=s),"$slice"==u&&(l=!0)}else e=o(c,i,r)}else p.push(r);e!==n&&(f[r]=a.isObject(e)?a.clone(e):e)}),l&&(f=a.defaults(f,a.omit(c,p))),e.push(f)}return e},$limit:function(r,n){return a.first(r,n)},$skip:function(r,n){return a.rest(r,n)},$unwind:function(r,n){for(var t=[],i=n.substr(1),u=0;u<r.length;u++){var o=r[u],s=e(o,i);if(!a.isArray(s))throw new Error("Target field '"+i+"' is not of type Array.");a.each(s,function(r){var n=a.clone(o);n[i]=r,t.push(n)})}return t},$sort:function(r,n){if(!a.isEmpty(n)&&a.isObject(n)){var t=a.keys(n);t.reverse().forEach(function(t){var e=[],u=a.groupBy(r,function(r){var n=i(r,t);return e.push(n),n});e=a.sortBy(a.uniq(e),function(r){return r}),-1===n[t]&&e.reverse(),r=[],a.each(e,function(n){Array.prototype.push.apply(r,u[n])})})}return r}},y={$and:function(r,n){if(!a.isArray(n))throw new Error("Invalid expression for $and criteria");var t=[];return a.each(n,function(r){t.push(new c.Query(r))}),{test:function(r){for(var n=0;n<t.length;n++)if(!t[n].test(r))return!1;return!0}}},$or:function(r,n){if(!a.isArray(n))throw new Error("Invalid expression for $or criteria");var t=[];return a.each(n,function(r){t.push(new c.Query(r))}),{test:function(r){for(var n=0;n<t.length;n++)if(t[n].test(r))return!0;return!1}}},$nor:function(r,n){if(!a.isArray(n))throw new Error("Invalid expression for $nor criteria");var t=this.$or("$or",n);return{test:function(r){return!t.test(r)}}},$not:function(r,n){var e={};e[r]=t(n);var i=new c.Query(e);return{test:function(r){return!i.test(r)}}},$where:function(r,n){return a.isFunction(n)||(n=new Function("return "+n+";")),{test:function(r){return n.call(r)===!0}}}},$={$eq:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isEqual(r,t)}),r!==n},$ne:function(r,n){return!this.$eq(r,n)},$in:function(r,n){return r=a.isArray(r)?r:[r],a.intersection(r,n).length>0},$nin:function(r,n){return a.isUndefined(r)||!this.$in(r,n)},$lt:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return t>r}),r!==n},$lte:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return t>=r}),r!==n},$gt:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return r>t}),r!==n},$gte:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return r>=t}),r!==n},$mod:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isNumber(r)&&a.isArray(t)&&2===t.length&&r%t[0]===t[1]}),r!==n},$regex:function(r,t){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isString(r)&&a.isRegExp(t)&&!!r.match(t)}),r!==n},$exists:function(r,n){return n===!1&&a.isUndefined(r)||n===!0&&!a.isUndefined(r)},$all:function(r,n){var t=this,e=!1;if(a.isArray(r)&&a.isArray(n))for(var i=0;i<n.length;i++){if(!a.isObject(n[i])||!a.contains(a.keys(n[i]),"$elemMatch"))return a.intersection(n,r).length===n.length;e=e||t.$elemMatch(r,n[i].$elemMatch)}return e},$size:function(r,n){return a.isArray(r)&&a.isNumber(n)&&r.length===n},$elemMatch:function(r,n){if(a.isArray(r)&&!a.isEmpty(r))for(var t=new c.Query(n),e=0;e<r.length;e++)if(t.test(r[e]))return!0;return!1},$type:function(r,n){switch(n){case 1:return a.isNumeric(r)&&-1!==(r+"").indexOf(".");case 2:case 5:return a.isString(r);case 3:return a.isObject(r);case 4:return a.isArray(r);case 8:return a.isBoolean(r);case 9:return a.isDate(r);case 10:return a.isNull(r);case 11:return a.isRegExp(r);case 16:return a.isNumeric(r)&&2147483647>=r&&-1===(r+"").indexOf(".");case 18:return a.isNumeric(r)&&r>2147483647&&0x8000000000000000>=r&&-1===(r+"").indexOf(".");default:return!1}}},d={$:function(){throw new Error("$ not implemented")},$elemMatch:function(r,t,e){var u=i(r,e),o=new c.Query(t);if(a.isUndefined(u)||!a.isArray(u))return n;for(var s=0;s<u.length;s++)if(o.test(u[s]))return[u[s]];return n},$slice:function(r,n,t){var e=i(r,t);if(!a.isArray(e))return e;if(a.isArray(n)){var u=n[0]<0?e.length+n[0]:n,o=u+n[1];n=[u,o]}else{if(!a.isNumber(n))throw new Error("Invalid type for $slice operator");n=0>n?[n]:[0,n]}return Array.prototype.slice.apply(e,n)}},m={$addToSet:function(r,n){var t=a.map(r,function(r){return o(r,n,null)});return a.uniq(t)},$sum:function(r,n){return a.isNumber(n)?r.length*n:a.reduce(r,function(r,t){return r+o(t,n,null)},0)},$max:function(r,n){var t=a.max(r,function(r){return o(r,n,null)});return o(t,n,null)},$min:function(r,n){var t=a.min(r,function(r){return o(r,n,null)});return o(t,n,null)},$avg:function(r,n){return this.$sum(r,n)/(r.length||1)},$push:function(r,n){return a.map(r,function(r){return o(r,n,null)})},$first:function(r,t){return r.length>0?o(r[0],t):n},$last:function(r,t){return r.length>0?o(r[r.length-1],t):n}},w={$add:function(r,n){var t=o(r,n,null);return a.reduce(t,function(r,n){return r+n},0)},$subtract:function(r,n){var t=o(r,n,null);return t[0]-t[1]},$divide:function(r,n){var t=o(r,n,null);return t[0]/t[1]},$multiply:function(r,n){var t=o(r,n,null);return a.reduce(t,function(r,n){return r*n},1)},$mod:function(r,n){var t=o(r,n,null);return t[0]%t[1]}},_={$concat:function(r,t){var e=o(r,t,null);return a.contains(e,null)||a.contains(e,n)?null:e.join("")},$strcasecmp:function(r,n){var t=o(r,n,null);return t[0]=a.isEmpty(t[0])?"":t[0].toUpperCase(),t[1]=a.isEmpty(t[1])?"":t[1].toUpperCase(),t[0]>t[1]?1:t[0]<t[1]?-1:0},$substr:function(r,n){var t=o(r,n,null);return a.isString(t[0])?t[1]<0?"":t[2]<0?t[0].substr(t[1]):t[0].substr(t[1],t[2]):""},$toLower:function(r,n){var t=o(r,n,null);return a.isEmpty(t)?"":t.toLowerCase()},$toUpper:function(r,n){var t=o(r,n,null);return a.isEmpty(t)?"":t.toUpperCase()}},O={$dayOfYear:function(r,t){var e=o(r,t,null);if(a.isDate(e)){var i=new Date(e.getFullYear(),0,0),u=e-i,s=864e5;return Math.round(u/s)}return n},$dayOfMonth:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getDate():n},$dayOfWeek:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getDay()+1:n},$year:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getFullYear():n},$month:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getMonth()+1:n},$week:function(r,n){o(r,n,null);throw new Error("Not Implemented")},$hour:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getHours():n},$minute:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getMinutes():n},$second:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getSeconds():n},$millisecond:function(r,t){var e=o(r,t,null);return a.isDate(e)?e.getMilliseconds():n},$dateToString:function(r,n){n.format,o(r,n.date);throw new Error("Not Implemented")}},x={$setEquals:function(r,n){var t=o(r,n,null),e=a.uniq(t[0]),i=a.uniq(t[1]);return e.length!==i.length?!1:0==a.difference(e,i).length},$setIntersection:function(r,n){var t=o(r,n,null);return a.intersection(t[0],t[1])},$setDifference:function(r,n){var t=o(r,n,null);return a.difference(t[0],t[1])},$setUnion:function(r,n){var t=o(r,n,null);return a.union(t[0],t[1])},$setIsSubset:function(r,n){var t=o(r,n,null);return a.intersection(t[0],t[1]).length===t[0].length},$anyElementTrue:function(r,n){for(var t=o(r,n,null)[0],e=0;e<t.length;e++)if(t[e])return!0;return!1},$allElementsTrue:function(r,n){for(var t=o(r,n,null)[0],e=0;e<t.length;e++)if(!t[e])return!1;return!0}},A={$cond:function(r,n){var t,e,i;if(a.isArray(n)){if(3!=n.length)throw new Error("Invalid arguments for $cond operator");t=n[0],e=n[1],i=n[2]}else a.isObject(n)&&(t=n["if"],e=n.then,i=n["else"]);var u=o(r,t,null);return u?o(r,e,null):o(r,i,null)},$ifNull:function(r,t){if(!a.isArray(t)||2!=t.length)throw new Error("Invalid arguments for $ifNull operator");var e=o(r,t,null);return null===e[0]||e[0]===n?e[1]:e[0]}},E={$cmp:function(r,n){var t=o(r,n,null);return t[0]>t[1]?1:t[0]<t[1]?-1:0}};a.each(["$eq","$ne","$gt","$gte","$lt","$lte"],function(r){E[r]=function(n,t){var e=o(n,t,null);return $[r](e[0],e[1])}});var k={$size:function(r,t){var e=o(r,t,null);return a.isArray(e)?e.length:n}},b={$literal:function(r,n){return n}},q={$map:function(r,n){var t=o(r,n.input,null);if(!a.isArray(t))throw new Error("Input expression for $map must resolve to an array");var e=n.as,i=n["in"],u="$"+e,s=r[u];return a.map(t,function(n){r[u]=n;var t=o(r,i,null);return a.isUndefined(s)?delete r[u]:r[u]=s,t})},$let:function(r,n){var t=n.vars,e=n["in"],i={},u=a.keys(t);a.each(u,function(n){var e=o(r,t[n],null),u="$"+n;i[u]=r[u],r[u]=e});var s=o(r,e,null);return a.each(u,function(n){var t="$"+n;a.isUndefined(i[t])?delete r[t]:r[t]=i[t]}),s}},j={$and:function(r,n){var t=o(r,n,null);return a.every(t)},$or:function(r,n){var t=o(r,n,null);return a.some(t)},$not:function(r,n){return!o(r,n[0],null)}},N=a.extend({},k,w,j,E,A,O,b,x,_,q),S={simpleOperators:a.keys($),compoundOperators:a.keys(y),aggregateOperators:a.keys(N),groupOperators:a.keys(m),pipelineOperators:a.keys(v),projectionOperators:a.keys(d)};S.queryOperators=a.union(S.simpleOperators,S.compoundOperators)}(this);